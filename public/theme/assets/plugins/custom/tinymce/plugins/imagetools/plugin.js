!function(t){"use strict";var n,e,r,o=function(t){var n=t;return{get:function(){return n},set:function(t){n=t}}},i=tinymce.util.Tools.resolve("tinymce.PluginManager"),u=tinymce.util.Tools.resolve("tinymce.util.Tools"),a=function(){},c=function(t){return function(){return t}},s=c(!1),f=c(!0),l=function(){return d},d=(n=function(t){return t.isNone()},{fold:function(t,n){return t()},is:s,isSome:s,isNone:f,getOr:r=function(t){return t},getOrThunk:e=function(t){return t()},getOrDie:function(t){throw new Error(t||"error: getOrDie called on none.")},getOrNull:c(null),getOrUndefined:c(void 0),or:r,orThunk:e,map:l,each:a,bind:l,exists:s,forall:f,filter:l,equals:n,equals_:n,toArray:function(){return[]},toString:c("none()")}),m=function(t){var n=c(t),e=function(){return o},r=function(n){return n(t)},o={fold:function(n,e){return e(t)},is:function(n){return t===n},isSome:f,isNone:s,getOr:n,getOrThunk:n,getOrDie:n,getOrNull:n,getOrUndefined:n,or:e,orThunk:e,map:function(n){return m(n(t))},each:function(n){n(t)},bind:r,exists:r,forall:r,filter:function(n){return n(t)?o:d},toArray:function(){return[t]},toString:function(){return"some("+t+")"},equals:function(n){return n.is(t)},equals_:function(n,e){return n.fold(s,function(n){return e(t,n)})}};return o},h={some:m,none:l,from:function(t){return null==t?d:m(t)}};function g(n,e){return y(t.document.createElement("canvas"),n,e)}function v(t){var n=g(t.width,t.height);return p(n).drawImage(t,0,0),n}function p(t){return t.getContext("2d")}function y(t,n,e){return t.width=n,t.height=e,t}var w=window.Promise?window.Promise:function(){var n=function(t){if("object"!=typeof this)throw new TypeError("Promises must be constructed via new");if("function"!=typeof t)throw new TypeError("not a function");this._state=null,this._value=null,this._deferreds=[],f(t,r(u,this),r(a,this))},e=n.immediateFn||"function"==typeof window.setImmediate&&window.setImmediate||function(n){t.setTimeout(n,1)};function r(t,n){return function(){return t.apply(n,arguments)}}var o=Array.isArray||function(t){return"[object Array]"===Object.prototype.toString.call(t)};function i(t){var n=this;null!==this._state?e(function(){var e=n._state?t.onFulfilled:t.onRejected;if(null!==e){var r;try{r=e(n._value)}catch(n){return void t.reject(n)}t.resolve(r)}else(n._state?t.resolve:t.reject)(n._value)}):this._deferreds.push(t)}function u(t){try{if(t===this)throw new TypeError("A promise cannot be resolved with itself.");if(t&&("object"==typeof t||"function"==typeof t)){var n=t.then;if("function"==typeof n)return void f(r(n,t),r(u,this),r(a,this))}this._state=!0,this._value=t,c.call(this)}catch(t){a.call(this,t)}}function a(t){this._state=!1,this._value=t,c.call(this)}function c(){for(var t=0,n=this._deferreds;t<n.length;t++){var e=n[t];i.call(this,e)}this._deferreds=[]}function s(t,n,e,r){this.onFulfilled="function"==typeof t?t:null,this.onRejected="function"==typeof n?n:null,this.resolve=e,this.reject=r}function f(t,n,e){var r=!1;try{t(function(t){r||(r=!0,n(t))},function(t){r||(r=!0,e(t))})}catch(t){if(r)return;r=!0,e(t)}}return n.prototype.catch=function(t){return this.then(null,t)},n.prototype.then=function(t,e){var r=this;return new n(function(n,o){i.call(r,new s(t,e,n,o))})},n.all=function(){for(var t=[],e=0;e<arguments.length;e++)t[e]=arguments[e];var r=Array.prototype.slice.call(1===t.length&&o(t[0])?t[0]:t);return new n(function(t,n){if(0===r.length)return t([]);var e=r.length;function o(i,u){try{if(u&&("object"==typeof u||"function"==typeof u)){var a=u.then;if("function"==typeof a)return void a.call(u,function(t){o(i,t)},n)}r[i]=u,0==--e&&t(r)}catch(t){n(t)}}for(var i=0;i<r.length;i++)o(i,r[i])})},n.resolve=function(t){return t&&"object"==typeof t&&t.constructor===n?t:new n(function(n){n(t)})},n.reject=function(t){return new n(function(n,e){e(t)})},n.race=function(t){return new n(function(n,e){for(var r=0,o=t;r<o.length;r++)o[r].then(n,e)})},n}();function b(n){var e,r=n.src;return 0===r.indexOf("data:")?T(r):(e=r,new w(function(n,r){var o=new t.XMLHttpRequest;o.open("GET",e,!0),o.responseType="blob",o.onload=function(){200===this.status&&n(this.response)},o.onerror=function(){var t,n=this;r(0===this.status?((t=new Error("No access to download image")).code=18,t.name="SecurityError",t):new Error("Error "+n.status+" downloading image"))},o.send()}))}function I(n){return new w(function(e,r){var o=t.URL.createObjectURL(n),i=new t.Image,u=function(){i.removeEventListener("load",a),i.removeEventListener("error",c)};function a(){u(),e(i)}function c(){u(),r("Unable to load data of type "+n.type+": "+o)}i.addEventListener("load",a),i.addEventListener("error",c),i.src=o,i.complete&&a()})}function T(n){return new w(function(e,r){(function(n){var e=n.split(","),r=/data:([^;]+)/.exec(e[0]);if(!r)return h.none();for(var o=r[1],i=e[1],u=t.atob(i),a=u.length,c=Math.ceil(a/1024),s=new Array(c),f=0;f<c;++f){for(var l=1024*f,d=Math.min(l+1024,a),m=new Array(d-l),g=l,v=0;g<d;++v,++g)m[v]=u[g].charCodeAt(0);s[f]=new Uint8Array(m)}return h.some(new t.Blob(s,{type:o}))})(n).fold(function(){r("uri is not base64: "+n)},e)})}function _(n,e,r){return e=e||"image/png",t.HTMLCanvasElement.prototype.toBlob?new w(function(t,o){n.toBlob(function(n){n?t(n):o()},e,r)}):T(n.toDataURL(e,r))}function R(n){return I(n).then(function(n){!function(n){t.URL.revokeObjectURL(n.src)}(n);var e=g(function(t){return t.naturalWidth||t.width}(n),function(t){return t.naturalHeight||t.height}(n));return p(e).drawImage(n,0,0),e})}function U(t,n,e){var r=n.type;function o(n,e){return t.then(function(t){return function(t,n,e){return n=n||"image/png",t.toDataURL(n,e)}(t,n,e)})}return{getType:c(r),toBlob:function(){return w.resolve(n)},toDataURL:c(e),toBase64:function(){return e.split(",")[1]},toAdjustedBlob:function(n,e){return t.then(function(t){return _(t,n,e)})},toAdjustedDataURL:o,toAdjustedBase64:function(t,n){return o(t,n).then(function(t){return t.split(",")[1]})},toCanvas:function(){return t.then(v)}}}function A(n){return function(n){return new w(function(e){var r=new t.FileReader;r.onloadend=function(){e(r.result)},r.readAsDataURL(n)})}(n).then(function(t){return U(R(n),n,t)})}function x(t,n){return _(t,n).then(function(n){return U(w.resolve(t),n,t.toDataURL())})}function E(t,n){return t.toCanvas().then(function(e){return function(t,n,e){var r=g(t.width,t.height),o=p(r),i=0,u=0;90!==(e=e<0?360+e:e)&&270!==e||y(r,r.height,r.width);90!==e&&180!==e||(i=r.width);270!==e&&180!==e||(u=r.height);return o.translate(i,u),o.rotate(e*Math.PI/180),o.drawImage(t,0,0),x(r,n)}(e,t.getType(),n)})}function L(t,n){return t.toCanvas().then(function(e){return function(t,n,e){var r=g(t.width,t.height),o=p(r);"v"===e?(o.scale(1,-1),o.drawImage(t,0,-r.height)):(o.scale(-1,1),o.drawImage(t,-r.width,0));return x(r,n)}(e,t.getType(),n)})}var j=function(t,n){return function(t,n,e){for(var r=0,o=t.length;r<o;r++){var i=t[r];if(n(i,r))return h.some(i);if(e(i,r))break}return h.none()}(t,n,s)},C=function(t){return A(t)},k=tinymce.util.Tools.resolve("tinymce.util.Delay"),O=tinymce.util.Tools.resolve("tinymce.util.Promise"),P=tinymce.util.Tools.resolve("tinymce.util.URI"),S=function(t){return t.getParam("imagetools_toolbar","rotateleft rotateright flipv fliph editimage imageoptions")};function M(t){var n,e;function r(t){return/^[0-9\.]+px$/.test(t)}return n=t.style.width,e=t.style.height,n||e?r(n)&&r(e)?{w:parseInt(n,10),h:parseInt(e,10)}:null:(n=t.width,e=t.height,n&&e?{w:parseInt(n,10),h:parseInt(e,10)}:null)}function B(t){return{w:t.naturalWidth,h:t.naturalHeight}}var N=function(t){return null!=t},D=function(n,e,r){return new O(function(o){var i;(i=new t.XMLHttpRequest).onreadystatechange=function(){4===i.readyState&&o({status:i.status,blob:this.response})},i.open("GET",n,!0),i.withCredentials=r,u.each(e,function(t,n){i.setRequestHeader(n,t)}),i.responseType="blob",i.send()})},F=[{code:404,message:"Could not find Image Proxy"},{code:403,message:"Rejected request"},{code:0,message:"Incorrect Image Proxy URL"}],H=[{type:"key_missing",message:"The request did not include an api key."},{type:"key_not_found",message:"The provided api key could not be found."},{type:"domain_not_trusted",message:"The api key is not valid for the request origins."}],q=function(t){var n=function(t){return"ImageProxy HTTP error: "+j(F,function(n){return t===n.code}).fold(c("Unknown ImageProxy error"),function(t){return t.message})}(t);return O.reject(n)},z=function(t){var n,e,r=function(t){var n;try{n=JSON.parse(t)}catch(t){}return n}(t),o=(n=["error","type"].reduce(function(t,n){return N(t)?t[n]:void 0},r),N(n)?n:null);return"ImageProxy Service error: "+(o?(e=o,j(H,function(t){return t.type===e}).fold(c("Unknown service error"),function(t){return t.message})):"Invalid JSON in service error message")},$=function(n,e){return function(n){return new O(function(e){var r=new t.FileReader;r.onload=function(t){var n=t.target;e(n.result)},r.readAsText(n)})}(e).then(function(t){var n=z(t);return O.reject(n)})},G=function(t,n){var e={"Content-Type":"application/json;charset=UTF-8","tiny-api-key":n};return D(function(t,n){var e=-1===t.indexOf("?")?"?":"&";return/[?&]apiKey=/.test(t)||!n?t:t+e+"apiKey="+encodeURIComponent(n)}(t,n),e,!1).then(function(t){return t.status<200||t.status>=300?(n=t.status,e=t.blob,400===(r=n)||403===r||500===r?$(0,e):q(n)):O.resolve(t.blob);var n,e,r})};var J=function(t,n,e){return n?G(t,n):function(t,n){return D(t,{},n).then(function(t){return t.status<200||t.status>=300?q(t.status):O.resolve(t.blob)})}(t,e)},K=function(t){if(null==t)throw new Error("Node cannot be null or undefined");return{dom:c(t)}},V={fromHtml:function(n,e){var r=(e||t.document).createElement("div");if(r.innerHTML=n,!r.hasChildNodes()||r.childNodes.length>1)throw t.console.error("HTML does not have a single root node",n),new Error("HTML must have a single root node");return K(r.childNodes[0])},fromTag:function(n,e){var r=(e||t.document).createElement(n);return K(r)},fromText:function(n,e){var r=(e||t.document).createTextNode(n);return K(r)},fromDom:K,fromPoint:function(t,n,e){var r=t.dom();return h.from(r.elementFromPoint(n,e)).map(K)}},W=(void 0!==t.window?t.window:Function("return this;")(),function(t,n){return function(t,n){return j(t.dom().childNodes,function(t){return n(V.fromDom(t))}).map(V.fromDom)}(t,function(t){return function(t,n){var e=t.dom();if(1!==e.nodeType)return!1;var r=e;if(void 0!==r.matches)return r.matches(n);if(void 0!==r.msMatchesSelector)return r.msMatchesSelector(n);if(void 0!==r.webkitMatchesSelector)return r.webkitMatchesSelector(n);if(void 0!==r.mozMatchesSelector)return r.mozMatchesSelector(n);throw new Error("Browser lacks native selectors")}(t,n)})}),X=0,Q=function(t){return W(V.fromDom(t),"img")},Y=function(t,n){return t.dom.is(n,"figure")},Z=function(t,n){var e=function(n){return function(n){return t.dom.is(n,"img:not([data-mce-object],[data-mce-placeholder])")}(n)&&(et(t,n)||rt(t,n)||t.settings.imagetools_proxy)};return Y(t,n)?Q(n).map(function(t){return e(t.dom())?h.some(t.dom()):h.none()}):e(n)?h.some(n):h.none()},tt=function(t,n){t.notificationManager.open({text:n,type:"error"})},nt=function(t){var n=t.selection.getNode();return Y(t,n)?Q(n):h.some(V.fromDom(n))},et=function(t,n){var e=n.src;return 0===e.indexOf("data:")||0===e.indexOf("blob:")||new P(e).host===t.documentBaseURI.host},rt=function(t,n){return-1!==u.inArray(function(t){return t.getParam("imagetools_cors_hosts",[],"string[]")}(t),new P(n.src).host)},ot=function(t,n){var e,r=n.src;return rt(t,n)?J(n.src,null,function(t,n){return-1!==u.inArray(function(t){return t.getParam("imagetools_credentials_hosts",[],"string[]")}(t),new P(n.src).host)}(t,n)):et(t,n)?b(n):(r=function(t){return t.getParam("imagetools_proxy")}(t),r+=(-1===r.indexOf("?")?"?":"&")+"url="+encodeURIComponent(n.src),e=function(t){return t.getParam("api_key",t.getParam("imagetools_api_key","","string"),"string")}(t),J(r,e,!1))},it=function(t,n){return function(t){return h.from(t.getParam("imagetools_fetch_image",null,"function"))}(t).fold(function(){return ot(t,n)},function(t){return t(n)})},ut=function(t,n){var e;return(e=t.editorUpload.blobCache.getByUri(n.src))?O.resolve(e.blob()):it(t,n)},at=function(t,n){var e=k.setEditorTimeout(t,function(){t.editorUpload.uploadImagesAuto()},function(t){return t.getParam("images_upload_timeout",3e4,"number")}(t));n.set(e)},ct=function(t){k.clearTimeout(t.get())},st=function(t,n,e,r,o,i){return n.toBlob().then(function(u){var a,c,s,f;return s=t.editorUpload.blobCache,a=o.src,function(t){return t.getParam("images_reuse_filename",!1,"boolean")}(t)&&((f=s.getByUri(a))?(a=f.uri(),c=f.name()):c=function(t,n){var e=n.match(/\/([^\/\?]+)?\.(?:jpeg|jpg|png|gif)(?:\?|$)/i);return e?t.dom.encode(e[1]):null}(t,a)),f=s.create({id:"imagetools"+X++,blob:u,base64:n.toBase64(),uri:a,name:c}),s.add(f),t.undoManager.transact(function(){t.$(o).on("load",function n(){t.$(o).off("load",n),t.nodeChanged(),e?t.editorUpload.uploadImagesAuto():(ct(r),at(t,r))}),i&&t.$(o).attr({width:i.w,height:i.h}),t.$(o).attr({src:f.blobUri()}).removeAttr("data-mce-src")}),f})},ft=function(t,n,e,r){return function(){return nt(t).fold(function(){tt(t,"Could not find selected image")},function(o){return t._scanForImages().then(function(){return ut(t,o.dom())}).then(C).then(e).then(function(e){return st(t,e,!1,n,o.dom(),r)},function(n){tt(t,n)})})}},lt=function(t,n,e){return function(){var r=nt(t).fold(function(){return null},function(t){var n=M(t.dom());return n?{w:n.h,h:n.w}:null});return ft(t,n,function(t){return function(t,n){return E(t,n)}(t,e)},r)()}},dt=function(t,n,e){return function(){return ft(t,n,function(t){return function(t,n){return L(t,n)}(t,e)})()}},mt=function(n,e,r,o,i){return function(t){return I(t)}(i).then(function(n){var e=B(n);return o.w===e.w&&o.h===e.h||M(r)&&function(t,n){var e,r;n&&(e=t.style.width,r=t.style.height,(e||r)&&(t.style.width=n.w+"px",t.style.height=n.h+"px",t.removeAttribute("data-mce-style")),e=t.width,r=t.height,(e||r)&&(t.setAttribute("width",n.w),t.setAttribute("height",n.h)))}(r,e),t.URL.revokeObjectURL(n.src),i}).then(C).then(function(t){return st(n,t,!0,e,r)},function(){})},ht=function(n,e){return function(){var r=nt(n),o=r.map(function(t){return B(t.dom())});nt(n).each(function(i){Z(n,i.dom()).each(function(u){ut(n,i.dom()).then(function(i){var u=function(n){return{blob:n,url:t.URL.createObjectURL(n)}}(i);n.windowManager.open({title:"Edit Image",size:"large",body:{type:"panel",items:[{type:"imagetools",name:"imagetools",label:"Edit Image",currentState:u}]},buttons:[{type:"cancel",name:"cancel",text:"Cancel"},{type:"submit",name:"save",text:"Save",primary:!0,disabled:!0}],onSubmit:function(t){var i=t.getData().imagetools.blob;r.each(function(t){o.each(function(r){mt(n,e,t.dom(),r,i)})}),t.close()},onCancel:function(){},onAction:function(t,n){switch(n.name){case"save-state":n.value?t.enable("save"):t.disable("save");break;case"disable":t.disable("save"),t.disable("cancel");break;case"enable":t.enable("cancel")}}})})})})}},gt=function(t,n){u.each({mceImageRotateLeft:lt(t,n,-90),mceImageRotateRight:lt(t,n,90),mceImageFlipVertical:dt(t,n,"v"),mceImageFlipHorizontal:dt(t,n,"h"),mceEditImage:ht(t,n)},function(n,e){t.addCommand(e,n)})},vt=function(t,n,e){t.on("NodeChange",function(r){var o=e.get();o&&o.src!==r.element.src&&(ct(n),t.editorUpload.uploadImagesAuto(),e.set(null)),Z(t,r.element).each(e.set)})},pt=function(t){var n=function(n){return function(){return t.execCommand(n)}};t.ui.registry.addButton("rotateleft",{tooltip:"Rotate counterclockwise",icon:"rotate-left",onAction:n("mceImageRotateLeft")}),t.ui.registry.addButton("rotateright",{tooltip:"Rotate clockwise",icon:"rotate-right",onAction:n("mceImageRotateRight")}),t.ui.registry.addButton("flipv",{tooltip:"Flip vertically",icon:"flip-vertically",onAction:n("mceImageFlipVertical")}),t.ui.registry.addButton("fliph",{tooltip:"Flip horizontally",icon:"flip-horizontally",onAction:n("mceImageFlipHorizontal")}),t.ui.registry.addButton("editimage",{tooltip:"Edit image",icon:"edit-image",onAction:n("mceEditImage"),onSetup:function(n){var e=function(){nt(t).each(function(e){var r=Z(t,e.dom()).isNone();n.setDisabled(r)})};return t.on("NodeChange",e),function(){t.off("NodeChange",e)}}}),t.ui.registry.addButton("imageoptions",{tooltip:"Image options",icon:"image-options",onAction:n("mceImage")}),t.ui.registry.addContextMenu("imagetools",{update:function(e){return Z(t,e).fold(function(){return[]},function(t){return[{text:"Edit image",icon:"edit-image",onAction:n("mceEditImage")}]})}})},yt=function(t){t.ui.registry.addContextToolbar("imagetools",{items:S(t),predicate:function(n){return Z(t,n).isSome()},position:"node",scope:"node"})};i.add("imagetools",function(t){var n=o(0),e=o(null);gt(t,n),pt(t),yt(t),vt(t,n,e)})}(window);